<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Persistencia de Datos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .section h3 {
            margin: 0 0 15px 0;
            color: #1f2937;
        }
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
        }
        .button:hover {
            background: #2563eb;
        }
        .button.success { background: #10b981; }
        .button.warning { background: #f59e0b; }
        .button.danger { background: #ef4444; }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .result.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .result.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .result.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .comparison-item {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .comparison-item h4 {
            margin: 0 0 10px 0;
            color: #1f2937;
        }
        .student-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico - Problema de Persistencia</h1>
        <p>Esta p√°gina ayuda a diagnosticar por qu√© los datos se revierten al recargar.</p>

        <div class="section">
            <h3>1. Verificar Fuentes de Datos</h3>
            <button class="button" onclick="checkDataSources()">üîç Verificar Fuentes</button>
            <div id="dataSourcesResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>2. Comparar Datos API vs Archivo Est√°tico</h3>
            <button class="button" onclick="compareDataSources()">‚öñÔ∏è Comparar Fuentes</button>
            <div id="comparisonResult" class="result" style="display: none;"></div>
            <div id="comparisonDetails" class="comparison" style="display: none;">
                <div class="comparison-item">
                    <h4>üì° Datos desde API</h4>
                    <div id="apiData"></div>
                </div>
                <div class="comparison-item">
                    <h4>üìÅ Datos desde Archivo Est√°tico</h4>
                    <div id="staticData"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>3. Probar Actualizaci√≥n y Verificar Persistencia</h3>
            <p>Selecciona un estudiante para probar:</p>
            <select id="studentSelect" style="width: 100%; padding: 8px; margin: 10px 0;">
                <option value="">Primero carga los datos</option>
            </select>
            <div>
                <button class="button success" onclick="testUpdate()">üíæ Actualizar Estudiante</button>
                <button class="button warning" onclick="testReload()">üîÑ Simular Recarga</button>
            </div>
            <div id="updateTestResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>4. Regenerar Archivo Est√°tico</h3>
            <p>Si hay inconsistencias, regenera el archivo est√°tico desde la BD:</p>
            <button class="button danger" onclick="regenerateStaticFile()">üîß Regenerar Archivo</button>
            <div id="regenerateResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>5. Estado del Sistema</h3>
            <div id="systemStatus">
                <p>Cargando estado del sistema...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="public/js/students-data.js"></script>
    
    <script>
        const institutionId = 'cmdt7n66m00003t1jy17ay313';
        let apiStudents = [];
        let staticStudents = [];
        let selectedStudent = null;

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function checkDataSources() {
            try {
                showResult('dataSourcesResult', 'Verificando fuentes de datos...', 'info');
                
                let report = 'üîç DIAGN√ìSTICO DE FUENTES DE DATOS:\n\n';
                
                // Verificar archivo est√°tico
                if (window.STUDENTS_DATA && Array.isArray(window.STUDENTS_DATA)) {
                    staticStudents = window.STUDENTS_DATA;
                    report += `üìÅ Archivo Est√°tico (window.STUDENTS_DATA):\n`;
                    report += `   ‚úÖ Disponible: ${staticStudents.length} estudiantes\n`;
                    report += `   üìä Primer estudiante: ${staticStudents[0]?.fullName || 'N/A'}\n`;
                    report += `   üïí √öltimo estudiante: ${staticStudents[staticStudents.length - 1]?.fullName || 'N/A'}\n\n`;
                } else {
                    report += `üìÅ Archivo Est√°tico: ‚ùå No disponible\n\n`;
                }
                
                // Verificar API
                try {
                    const response = await fetch(`/api/students/${institutionId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.students) {
                            apiStudents = data.students;
                            report += `üì° API (/api/students/${institutionId}):\n`;
                            report += `   ‚úÖ Disponible: ${apiStudents.length} estudiantes\n`;
                            report += `   üìä Primer estudiante: ${apiStudents[0]?.fullName || 'N/A'}\n`;
                            report += `   üïí √öltimo estudiante: ${apiStudents[apiStudents.length - 1]?.fullName || 'N/A'}\n\n`;
                        } else {
                            report += `üì° API: ‚ùå Respuesta inv√°lida\n\n`;
                        }
                    } else {
                        report += `üì° API: ‚ùå Error HTTP ${response.status}\n\n`;
                    }
                } catch (error) {
                    report += `üì° API: ‚ùå Error de conexi√≥n: ${error.message}\n\n`;
                }
                
                // Verificar localStorage
                const localStorageKeys = ['students', 'estudiantes', 'studentsData', 'allStudents'];
                let foundInLocalStorage = false;
                for (const key of localStorageKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            if (Array.isArray(parsed) && parsed.length > 0) {
                                report += `üíæ localStorage['${key}']: ‚úÖ ${parsed.length} estudiantes\n`;
                                foundInLocalStorage = true;
                            }
                        } catch (e) {
                            report += `üíæ localStorage['${key}']: ‚ùå Error parsing\n`;
                        }
                    }
                }
                if (!foundInLocalStorage) {
                    report += `üíæ localStorage: ‚ùå No hay datos de estudiantes\n`;
                }
                
                report += '\nüéØ CONCLUSI√ìN:\n';
                if (apiStudents.length > 0 && staticStudents.length > 0) {
                    if (apiStudents.length === staticStudents.length) {
                        report += '‚úÖ Ambas fuentes tienen la misma cantidad de estudiantes\n';
                    } else {
                        report += `‚ö†Ô∏è Diferencia en cantidad: API(${apiStudents.length}) vs Est√°tico(${staticStudents.length})\n`;
                    }
                } else if (apiStudents.length > 0) {
                    report += '‚ö†Ô∏è Solo API disponible, archivo est√°tico puede estar desactualizado\n';
                } else if (staticStudents.length > 0) {
                    report += '‚ö†Ô∏è Solo archivo est√°tico disponible, API no funciona\n';
                } else {
                    report += '‚ùå No hay datos disponibles en ninguna fuente\n';
                }
                
                showResult('dataSourcesResult', report, 'info');
                
                // Llenar selector de estudiantes
                fillStudentSelector();
                
            } catch (error) {
                showResult('dataSourcesResult', `‚ùå Error en diagn√≥stico: ${error.message}`, 'error');
            }
        }

        async function compareDataSources() {
            if (apiStudents.length === 0 || staticStudents.length === 0) {
                showResult('comparisonResult', '‚ùå Primero ejecuta "Verificar Fuentes" para cargar los datos', 'error');
                return;
            }

            try {
                showResult('comparisonResult', 'Comparando fuentes de datos...', 'info');
                
                // Buscar diferencias
                let differences = [];
                let sampleSize = Math.min(5, apiStudents.length, staticStudents.length);
                
                for (let i = 0; i < sampleSize; i++) {
                    const apiStudent = apiStudents[i];
                    const staticStudent = staticStudents.find(s => s.id === apiStudent.id);
                    
                    if (staticStudent) {
                        if (apiStudent.fullName !== staticStudent.fullName ||
                            apiStudent.address !== staticStudent.address ||
                            apiStudent.email !== staticStudent.email) {
                            differences.push({
                                id: apiStudent.id,
                                api: apiStudent,
                                static: staticStudent
                            });
                        }
                    }
                }
                
                let report = `‚öñÔ∏è COMPARACI√ìN DE FUENTES:\n\n`;
                report += `üìä Estudiantes en API: ${apiStudents.length}\n`;
                report += `üìä Estudiantes en Archivo: ${staticStudents.length}\n`;
                report += `üîç Diferencias encontradas: ${differences.length}\n\n`;
                
                if (differences.length > 0) {
                    report += `‚ö†Ô∏è INCONSISTENCIAS DETECTADAS:\n`;
                    differences.forEach((diff, index) => {
                        report += `\n${index + 1}. Estudiante ID: ${diff.id}\n`;
                        report += `   API: ${diff.api.fullName} | ${diff.api.address}\n`;
                        report += `   Archivo: ${diff.static.fullName} | ${diff.static.address}\n`;
                    });
                    report += `\nüéØ PROBLEMA IDENTIFICADO: El archivo est√°tico est√° desactualizado\n`;
                    report += `üí° SOLUCI√ìN: Regenerar el archivo est√°tico desde la base de datos\n`;
                } else {
                    report += `‚úÖ No se encontraron inconsistencias en la muestra analizada\n`;
                }
                
                showResult('comparisonResult', report, differences.length > 0 ? 'error' : 'success');
                
                // Mostrar detalles visuales
                document.getElementById('comparisonDetails').style.display = 'grid';
                
                // Mostrar datos de API
                const apiDataDiv = document.getElementById('apiData');
                apiDataDiv.innerHTML = apiStudents.slice(0, 3).map(s => `
                    <div class="student-card">
                        <strong>${s.fullName}</strong><br>
                        üìß ${s.email}<br>
                        üè† ${s.address}<br>
                        üéì ${s.grade}¬∞ - ${s.course}
                    </div>
                `).join('');
                
                // Mostrar datos est√°ticos
                const staticDataDiv = document.getElementById('staticData');
                staticDataDiv.innerHTML = staticStudents.slice(0, 3).map(s => `
                    <div class="student-card">
                        <strong>${s.fullName}</strong><br>
                        üìß ${s.email}<br>
                        üè† ${s.address}<br>
                        üéì ${s.grade}¬∞ - ${s.course}
                    </div>
                `).join('');
                
            } catch (error) {
                showResult('comparisonResult', `‚ùå Error comparando: ${error.message}`, 'error');
            }
        }

        function fillStudentSelector() {
            const select = document.getElementById('studentSelect');
            const students = apiStudents.length > 0 ? apiStudents : staticStudents;
            
            select.innerHTML = '<option value="">Selecciona un estudiante</option>';
            students.slice(0, 10).forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.fullName} (${student.grade}¬∞ - ${student.course})`;
                select.appendChild(option);
            });
        }

        async function testUpdate() {
            const studentId = document.getElementById('studentSelect').value;
            if (!studentId) {
                showResult('updateTestResult', '‚ùå Selecciona un estudiante primero', 'error');
                return;
            }

            try {
                selectedStudent = (apiStudents.length > 0 ? apiStudents : staticStudents).find(s => s.id === studentId);
                
                showResult('updateTestResult', 'Probando actualizaci√≥n...', 'info');
                
                const timestamp = new Date().toLocaleTimeString();
                const updateData = {
                    nombre: selectedStudent.firstName,
                    apellido: `${selectedStudent.lastName} [TEST ${timestamp}]`,
                    documento: selectedStudent.document,
                    email: selectedStudent.email,
                    telefono: selectedStudent.phone,
                    grado: selectedStudent.grade,
                    curso: selectedStudent.course,
                    direccion: `Direcci√≥n TEST ${timestamp}`,
                    acudienteNombre: selectedStudent.guardian?.name || 'Acudiente',
                    acudienteTelefono: selectedStudent.guardian?.phone || '+57 300 000 0000',
                    acudienteEmail: selectedStudent.guardian?.email || 'acudiente@email.com'
                };

                const response = await fetch(`/api/students/student/${studentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult('updateTestResult', `‚úÖ Actualizaci√≥n exitosa!\n\nDatos enviados:\n${JSON.stringify(updateData, null, 2)}\n\nRespuesta:\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    const error = await response.json();
                    showResult('updateTestResult', `‚ùå Error en actualizaci√≥n: ${response.status}\n${JSON.stringify(error, null, 2)}`, 'error');
                }

            } catch (error) {
                showResult('updateTestResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testReload() {
            if (!selectedStudent) {
                showResult('updateTestResult', '‚ùå Primero actualiza un estudiante', 'error');
                return;
            }

            try {
                showResult('updateTestResult', 'Simulando recarga de p√°gina...', 'info');
                
                // Simular recarga obteniendo datos frescos
                const response = await fetch(`/api/students/${institutionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.students) {
                        const reloadedStudent = data.students.find(s => s.id === selectedStudent.id);
                        
                        if (reloadedStudent) {
                            let report = 'üîÑ RESULTADO DE SIMULACI√ìN DE RECARGA:\n\n';
                            report += `üìã Estudiante: ${selectedStudent.fullName}\n`;
                            report += `üîç Datos despu√©s de "recarga":\n`;
                            report += `   Nombre: ${reloadedStudent.fullName}\n`;
                            report += `   Direcci√≥n: ${reloadedStudent.address}\n\n`;
                            
                            if (reloadedStudent.fullName.includes('[TEST') || reloadedStudent.address.includes('TEST')) {
                                report += '‚úÖ PERSISTENCIA EXITOSA: Los cambios se mantuvieron despu√©s de la recarga simulada\n';
                                showResult('updateTestResult', report, 'success');
                            } else {
                                report += '‚ùå PERSISTENCIA FALLIDA: Los cambios se perdieron despu√©s de la recarga simulada\n';
                                report += 'üí° Esto indica que el archivo est√°tico est√° sobrescribiendo los datos de la API\n';
                                showResult('updateTestResult', report, 'error');
                            }
                        } else {
                            showResult('updateTestResult', '‚ùå Estudiante no encontrado despu√©s de recarga', 'error');
                        }
                    }
                } else {
                    showResult('updateTestResult', '‚ùå Error obteniendo datos despu√©s de recarga', 'error');
                }

            } catch (error) {
                showResult('updateTestResult', `‚ùå Error en simulaci√≥n: ${error.message}`, 'error');
            }
        }

        async function regenerateStaticFile() {
            try {
                showResult('regenerateResult', 'Regenerando archivo est√°tico...', 'info');
                
                // Llamar al endpoint para regenerar
                const response = await fetch('/api/regenerate-students-data', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showResult('regenerateResult', '‚úÖ Archivo est√°tico regenerado exitosamente!\n\nAhora recarga la p√°gina para ver los cambios.', 'success');
                } else {
                    showResult('regenerateResult', '‚ö†Ô∏è No hay endpoint autom√°tico. Ejecuta manualmente:\nnode scripts/regenerate-students-data.js', 'info');
                }
                
            } catch (error) {
                showResult('regenerateResult', `‚ö†Ô∏è Regeneraci√≥n manual necesaria:\nEjecuta: node scripts/regenerate-students-data.js\n\nError: ${error.message}`, 'info');
            }
        }

        function updateSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = `
                <h4>üîß Estado Actual:</h4>
                <p>‚Ä¢ <strong>API Estudiantes:</strong> ${apiStudents.length} cargados</p>
                <p>‚Ä¢ <strong>Archivo Est√°tico:</strong> ${staticStudents.length} cargados</p>
                <p>‚Ä¢ <strong>Estudiante Seleccionado:</strong> ${selectedStudent ? selectedStudent.fullName : 'Ninguno'}</p>
                <p>‚Ä¢ <strong>Hora:</strong> ${new Date().toLocaleString()}</p>
            `;
        }

        // Actualizar estado cada 10 segundos
        setInterval(updateSystemStatus, 10000);
        updateSystemStatus();

        // Cargar datos autom√°ticamente al iniciar
        setTimeout(checkDataSources, 1000);
    </script>
</body>
</html>