<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Simple - Persistencia</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 600;
        }
        .button:hover { background: #2563eb; }
        .button.success { background: #10b981; }
        .button.danger { background: #ef4444; }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .result.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .result.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .result.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        .student-select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Simple - Persistencia de Datos</h1>
        
        <div class="section">
            <h3>Paso 1: Cargar Estudiantes</h3>
            <button class="button" onclick="loadStudents()">üì• Cargar desde API</button>
            <div id="loadResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>Paso 2: Seleccionar Estudiante para Probar</h3>
            <select id="studentSelect" class="student-select">
                <option value="">Primero carga los estudiantes</option>
            </select>
            <div id="studentInfo" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>Paso 3: Actualizar Estudiante</h3>
            <button class="button success" onclick="updateStudent()">üíæ Actualizar Datos</button>
            <div id="updateResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>Paso 4: Verificar Persistencia</h3>
            <button class="button danger" onclick="reloadAndCheck()">üîÑ Recargar y Verificar</button>
            <div id="persistenceResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const institutionId = 'cmdt7n66m00003t1jy17ay313';
        let allStudents = [];
        let selectedStudent = null;
        let updateTimestamp = null;

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function loadStudents() {
            try {
                showResult('loadResult', 'Cargando estudiantes desde API...', 'info');
                
                const response = await fetch(`/api/students/${institutionId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.students) {
                        allStudents = data.students;
                        showResult('loadResult', `‚úÖ ${allStudents.length} estudiantes cargados exitosamente`, 'success');
                        
                        // Llenar selector
                        const select = document.getElementById('studentSelect');
                        select.innerHTML = '<option value="">Selecciona un estudiante</option>';
                        
                        allStudents.slice(0, 20).forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.id;
                            option.textContent = `${student.fullName} (${student.grade}¬∞ - ${student.course})`;
                            select.appendChild(option);
                        });
                        
                    } else {
                        showResult('loadResult', `‚ùå Error en respuesta: ${JSON.stringify(data)}`, 'error');
                    }
                } else {
                    showResult('loadResult', `‚ùå Error HTTP: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('loadResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        function onStudentSelect() {
            const select = document.getElementById('studentSelect');
            const studentId = select.value;
            
            if (studentId) {
                selectedStudent = allStudents.find(s => s.id === studentId);
                
                if (selectedStudent) {
                    const info = `üë§ Estudiante Seleccionado:
Nombre: ${selectedStudent.fullName}
Email: ${selectedStudent.email}
Direcci√≥n: ${selectedStudent.address}
Grado: ${selectedStudent.grade}¬∞ - Curso ${selectedStudent.course}`;
                    
                    showResult('studentInfo', info, 'info');
                }
            } else {
                document.getElementById('studentInfo').style.display = 'none';
                selectedStudent = null;
            }
        }

        async function updateStudent() {
            if (!selectedStudent) {
                showResult('updateResult', '‚ùå Primero selecciona un estudiante', 'error');
                return;
            }

            try {
                updateTimestamp = new Date().toLocaleTimeString();
                showResult('updateResult', 'Actualizando estudiante...', 'info');
                
                const updateData = {
                    nombre: selectedStudent.firstName,
                    apellido: selectedStudent.lastName,
                    documento: selectedStudent.document,
                    email: selectedStudent.email,
                    telefono: selectedStudent.phone,
                    grado: selectedStudent.grade,
                    curso: selectedStudent.course,
                    direccion: `DIRECCI√ìN ACTUALIZADA ${updateTimestamp}`,
                    acudienteNombre: selectedStudent.guardian?.name || 'Acudiente',
                    acudienteTelefono: selectedStudent.guardian?.phone || '+57 300 000 0000',
                    acudienteEmail: selectedStudent.guardian?.email || 'acudiente@email.com'
                };

                console.log('üì§ Enviando actualizaci√≥n:', updateData);

                const response = await fetch(`/api/students/student/${selectedStudent.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult('updateResult', `‚úÖ Estudiante actualizado exitosamente!

Datos enviados:
- Direcci√≥n: ${updateData.direccion}

Respuesta del servidor:
${JSON.stringify(result, null, 2)}`, 'success');
                    
                    // Actualizar datos locales
                    selectedStudent.address = updateData.direccion;
                    
                } else {
                    const errorData = await response.json();
                    showResult('updateResult', `‚ùå Error actualizando: ${response.status}
${JSON.stringify(errorData, null, 2)}`, 'error');
                }

            } catch (error) {
                showResult('updateResult', `‚ùå Error de red: ${error.message}`, 'error');
            }
        }

        async function reloadAndCheck() {
            if (!selectedStudent || !updateTimestamp) {
                showResult('persistenceResult', '‚ùå Primero actualiza un estudiante', 'error');
                return;
            }

            try {
                showResult('persistenceResult', 'Verificando persistencia...', 'info');
                
                // Obtener datos frescos desde la API
                const response = await fetch(`/api/students/${institutionId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.students) {
                        const reloadedStudent = data.students.find(s => s.id === selectedStudent.id);
                        
                        if (reloadedStudent) {
                            const result = `üîç VERIFICACI√ìN DE PERSISTENCIA:

üìã Datos Originales:
- Direcci√≥n: ${selectedStudent.address}

üìã Datos Despu√©s de Recargar:
- Direcci√≥n: ${reloadedStudent.address}

${reloadedStudent.address.includes(updateTimestamp) ? 
'‚úÖ PERSISTENCIA EXITOSA: Los cambios se mantuvieron en la base de datos' : 
'‚ùå PERSISTENCIA FALLIDA: Los cambios se perdieron'}`;
                            
                            const resultType = reloadedStudent.address.includes(updateTimestamp) ? 'success' : 'error';
                            showResult('persistenceResult', result, resultType);
                            
                        } else {
                            showResult('persistenceResult', '‚ùå Estudiante no encontrado despu√©s de recargar', 'error');
                        }
                    } else {
                        showResult('persistenceResult', '‚ùå Error en respuesta de recarga', 'error');
                    }
                } else {
                    showResult('persistenceResult', `‚ùå Error HTTP en recarga: ${response.status}`, 'error');
                }

            } catch (error) {
                showResult('persistenceResult', `‚ùå Error en verificaci√≥n: ${error.message}`, 'error');
            }
        }

        // Event listener para el selector
        document.getElementById('studentSelect').addEventListener('change', onStudentSelect);

        // Instrucciones
        console.log('üß™ Test Simple de Persistencia');
        console.log('1. Haz clic en "Cargar desde API"');
        console.log('2. Selecciona un estudiante');
        console.log('3. Haz clic en "Actualizar Datos"');
        console.log('4. Haz clic en "Recargar y Verificar"');
    </script>
</body>
</html>